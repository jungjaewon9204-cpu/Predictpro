<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PredictPro — Secure Auth & APK Distribution</title>

  <!-- Tailwind CDN (for production set up Tailwind properly) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Small CSS for OTP boxes */
    .otp-input {
      width: 3.25rem;
      height: 3.25rem;
      text-align: center;
      font-size: 1.25rem;
    }
    .hidden-by-default { display: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-4">

  <div id="app" class="w-full max-w-xl bg-white rounded-2xl shadow-lg p-6 md:p-10">
    <!-- Header -->
    <header class="mb-6 text-center">
      <h1 class="text-2xl md:text-3xl font-extrabold">PredictPro</h1>
      <p class="mt-1 text-slate-500">Secure auth & APK distribution</p>
    </header>

    <!-- Auth form -->
    <div id="auth-panel">
      <div class="grid gap-4">
        <div class="flex gap-2 justify-center">
          <button id="btn-login" class="px-4 py-2 rounded-full bg-white border transition transform hover:scale-[1.02]">Login</button>
          <button id="btn-signup" class="px-4 py-2 rounded-full bg-indigo-600 text-white shadow hover:bg-indigo-700 transition">Sign Up</button>
        </div>

        <form id="auth-form" class="grid gap-3">
          <label class="text-sm text-slate-600">Email</label>
          <input id="email" type="email" autocomplete="off" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-200" placeholder="you@example.com">

          <label class="text-sm text-slate-600">Password</label>
          <input id="password" type="password" autocomplete="new-password" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-200" placeholder="Minimum 8 characters">

          <div class="flex items-center justify-between">
            <div class="text-xs text-slate-500">Password must be at least 8 characters, include letters & numbers</div>
            <button id="submit-auth" type="button" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition">Continue</button>
          </div>

          <div id="auth-msg" class="text-sm text-red-600 mt-2 hidden"></div>
        </form>
      </div>
    </div>

    <!-- OTP panel -->
    <div id="otp-panel" class="hidden-by-default mt-2">
      <div class="mb-4">
        <div class="text-sm text-slate-700">Enter the 6-digit OTP we sent to <span id="otp-email" class="font-medium"></span></div>
        <div class="text-xs text-red-600 mt-1">Do not enter OTP if you did not request it!</div>
      </div>

      <div class="flex gap-2 justify-center items-center mb-3">
        <input inputmode="numeric" maxlength="1" class="otp-input border rounded-lg" id="otp-1">
        <input inputmode="numeric" maxlength="1" class="otp-input border rounded-lg" id="otp-2">
        <input inputmode="numeric" maxlength="1" class="otp-input border rounded-lg" id="otp-3">
        <input inputmode="numeric" maxlength="1" class="otp-input border rounded-lg" id="otp-4">
        <input inputmode="numeric" maxlength="1" class="otp-input border rounded-lg" id="otp-5">
        <input inputmode="numeric" maxlength="1" class="otp-input border rounded-lg" id="otp-6">
      </div>

      <div class="flex items-center justify-center gap-4">
        <div id="timer" class="text-sm text-slate-600">Expires in: <span id="timer-seconds">60</span>s</div>
        <button id="verify-otp" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition">Verify OTP</button>
        <button id="resend-otp" class="px-3 py-2 rounded-lg bg-white border hover:bg-slate-50 transition">Resend</button>
      </div>

      <div id="otp-msg" class="text-sm text-red-600 mt-3 hidden"></div>
    </div>

    <!-- Success / APK -->
    <div id="success-panel" class="hidden-by-default mt-4 text-center">
      <h2 class="text-xl font-bold">Welcome, <span id="user-display"></span>!</h2>
      <p class="text-slate-600 mt-2">OTP verified — download available.</p>

      <div class="mt-4">
        <a id="download-apk" class="inline-block px-6 py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition" href="#" download>Download APK</a>
      </div>

      <div id="admin-panel" class="mt-4 hidden">
        <h3 class="font-semibold">Super Admin</h3>
        <p class="text-xs text-slate-500">Admin actions below are visible only for the super admin account.</p>
        <button id="admin-log" class="mt-2 px-4 py-2 bg-yellow-400 rounded-lg">Show Admin Log (console)</button>
      </div>
    </div>

    <!-- small footer -->
    <footer class="mt-6 text-xs text-slate-400 text-center">PredictPro — Secure Auth & APK Distribution</footer>
  </div>

<script>
/* ---------------- CONFIG ----------------
 * For real email sending: DEMO_MODE = false and configure server endpoints.
 * For demo / local-only testing: set DEMO_MODE = true.
 */
const DEMO_MODE = false; // <--- set true if you don't have a server
const API_BASE = '';     // If running server on same origin leave '' or set 'https://your-domain.com'

/* Super admin exact email */
const SUPER_ADMIN_EMAIL = 'shadowvybez001@gmail.com';

/* Internal in-memory session store (frontend-only demo) */
let session = {
  email: null,
  isSignup: false,
  otp: null,
  otpExpiresAt: null,
  otpUsed: false,
  isSuperAdmin: false
};

/* DOM refs */
const emailEl = document.getElementById('email');
const passwordEl = document.getElementById('password');
const authMsg = document.getElementById('auth-msg');
const otpPanel = document.getElementById('otp-panel');
const authPanel = document.getElementById('auth-panel');
const otpEmailEl = document.getElementById('otp-email');
const otpInputs = Array.from(Array(6).keys()).map(i => document.getElementById('otp-' + (i+1)));
const timerSecondsEl = document.getElementById('timer-seconds');
const otpMsg = document.getElementById('otp-msg');
const successPanel = document.getElementById('success-panel');
const userDisplay = document.getElementById('user-display');
const downloadApk = document.getElementById('download-apk');
const adminPanel = document.getElementById('admin-panel');

/* buttons */
document.getElementById('submit-auth').addEventListener('click', onContinue);
document.getElementById('verify-otp').addEventListener('click', onVerifyOtp);
document.getElementById('resend-otp').addEventListener('click', onResendOtp);
document.getElementById('btn-login').addEventListener('click', () => toggleAuthMode(false));
document.getElementById('btn-signup').addEventListener('click', () => toggleAuthMode(true));
document.getElementById('admin-log').addEventListener('click', () => console.log('Admin log — session:', session));

let otpTimerInterval = null;
let otpRemaining = 0;

/* ---------------- Utility validators ---------------- */
const emailRegex = /^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$/;
const passwordRegex = /^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d\\W]{8,}$/;

function toggleAuthMode(isSignup) {
  session.isSignup = isSignup;
  document.getElementById('btn-signup').classList.toggle('bg-indigo-600', isSignup);
  document.getElementById('btn-signup').classList.toggle('text-white', isSignup);
  document.getElementById('btn-login').classList.toggle('bg-white', isSignup);
  document.getElementById('btn-login').classList.toggle('border', isSignup);
}

/* OTP input auto-focus handling */
otpInputs.forEach((inp, idx) => {
  inp.addEventListener('input', (e) => {
    const v = e.target.value.replace(/[^0-9]/g, '');
    e.target.value = v;
    if (v && idx < otpInputs.length - 1) otpInputs[idx + 1].focus();
  });
  inp.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace' && !e.target.value && idx > 0) {
      otpInputs[idx - 1].focus();
    }
  });
});

/* ---------------- Auth continue -> request OTP ---------------- */
async function onContinue() {
  clearAuthMessages();
  const email = (emailEl.value || '').trim().toLowerCase();
  const pw = passwordEl.value || '';

  if (!emailRegex.test(email)) {
    showAuthError('Invalid email format.');
    return;
  }
  if (!passwordRegex.test(pw)) {
    showAuthError('Password must be at least 8 characters and include letters and numbers.');
    return;
  }

  // Set session
  session.email = email;
  session.isSuperAdmin = (email === SUPER_ADMIN_EMAIL);

  // Request server to send OTP OR generate locally (demo)
  try {
    if (DEMO_MODE) {
      // generate OTP locally (for demo only)
      const otp = (Math.floor(100000 + Math.random() * 900000)).toString();
      session.otp = otp;
      session.otpUsed = false;
      session.otpExpiresAt = Date.now() + 60 * 1000;
      console.info('DEMO OTP (do not share):', otp);
      showOtpPanel();
      startOtpTimer();
    } else {
      const res = await fetch(API_BASE + '/api/send-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, isSignup: session.isSignup })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.message || 'Failed to send OTP');

      // server returns { ok: true } if success
      session.otp = null; // server holds OTP
      session.otpUsed = false;
      session.otpExpiresAt = Date.now() + 60 * 1000;
      showOtpPanel();
      startOtpTimer();
    }
  } catch (err) {
    showAuthError('Could not send OTP: ' + err.message);
  }
}

function showOtpPanel() {
  authPanel.classList.add('hidden-by-default');
  otpPanel.classList.remove('hidden-by-default');
  otpEmailEl.textContent = session.email;
  otpInputs.forEach(i => i.value = '');
  otpInputs[0].focus();
  otpMsg.classList.add('hidden');
}

/* ---------------- Timer / expiry ---------------- */
function startOtpTimer() {
  clearInterval(otpTimerInterval);
  otpRemaining = 60;
  timerSecondsEl.textContent = otpRemaining;
  otpTimerInterval = setInterval(() => {
    otpRemaining -= 1;
    timerSecondsEl.textContent = otpRemaining;
    if (otpRemaining <= 0) {
      clearInterval(otpTimerInterval);
      showOtpError('OTP expired. Please resend.');
      session.otpExpiresAt = Date.now() - 1;
    }
  }, 1000);
}

/* ---------------- Verify OTP ---------------- */
async function onVerifyOtp() {
  clearOtpMessages();
  const otp = otpInputs.map(i => i.value).join('');
  if (!/^[0-9]{6}$/.test(otp)) {
    showOtpError('Enter the 6-digit numeric OTP.');
    return;
  }

  // Check expiry client-side if demo
  if (session.otpExpiresAt && Date.now() > session.otpExpiresAt) {
    showOtpError('OTP expired. Please request a new OTP.');
    return;
  }

  try {
    if (DEMO_MODE) {
      if (session.otpUsed) {
        showOtpError('OTP already used.');
        return;
      }
      if (otp === session.otp) {
        session.otpUsed = true;
        onAuthSuccess();
      } else {
        showOtpError('Incorrect OTP.');
      }
    } else {
      // Server verification
      const res = await fetch(API_BASE + '/api/verify-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: session.email, otp })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.message || 'OTP verification failed');
      onAuthSuccess();
    }
  } catch (err) {
    showOtpError('Verification failed: ' + err.message);
  }
}

function onAuthSuccess() {
  otpPanel.classList.add('hidden-by-default');
  successPanel.classList.remove('hidden-by-default');
  userDisplay.textContent = session.email;
  // Example: set download link (replace with your real apk path)
  downloadApk.href = 'files/predictpro-v1.0.0.apk';
  if (session.isSuperAdmin) adminPanel.classList.remove('hidden'); else adminPanel.classList.add('hidden');
  console.log('USER LOG:', { email: session.email, superAdmin: session.isSuperAdmin, timestamp: new Date().toISOString() });
}

/* ---------------- Resend OTP ---------------- */
async function onResendOtp() {
  clearOtpMessages();
  // small client-side rate-limit: disable resend for 10s
  const btn = document.getElementById('resend-otp');
  btn.disabled = true;
  setTimeout(() => btn.disabled = false, 10000);

  try {
    if (DEMO_MODE) {
      const otp = (Math.floor(100000 + Math.random() * 900000)).toString();
      session.otp = otp;
      session.otpUsed = false;
      session.otpExpiresAt = Date.now() + 60 * 1000;
      console.info('DEMO OTP (resend):', otp);
      startOtpTimer();
    } else {
      const res = await fetch(API_BASE + '/api/send-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: session.email, isResend: true })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.message || 'Failed to resend OTP');
      session.otpExpiresAt = Date.now() + 60 * 1000;
      startOtpTimer();
    }
  } catch (err) {
    showOtpError('Could not resend OTP: ' + err.message);
  }
}

/* ---------------- UI helpers ---------------- */
function showAuthError(msg) { authMsg.textContent = msg; authMsg.classList.remove('hidden'); }
function clearAuthMessages() { authMsg.textContent = ''; authMsg.classList.add('hidden'); }
function showOtpError(msg) { otpMsg.textContent = msg; otpMsg.classList.remove('hidden'); }
function clearOtpMessages() { otpMsg.textContent = ''; otpMsg.classList.add('hidden'); }

/* ---------------- Init ---------------- */
toggleAuthMode(false); // default to login
</script>
</body>
</html>
