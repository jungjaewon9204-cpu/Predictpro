<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PredictPro - Secure Auth</title>
    <!-- 1. Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for smooth transitions and focus */
        body {
            font-family: 'Inter', sans-serif;
        }
        .auth-card {
            transition: all 0.3s ease-in-out;
        }
        .form-input, .btn {
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); /* Tailwind's blue-300 with opacity */
            border-color: #60a5fa; /* blue-400 */
        }
        .otp-input {
            width: 3rem; /* 48px */
            height: 3.5rem; /* 56px */
            text-align: center;
            font-size: 1.25rem; /* 20px */
            border-radius: 0.5rem; /* 8px */
            border: 1px solid #D1D5DB; /* gray-300 */
            transition: all 0.2s ease-in-out;
        }
        .otp-input:focus {
            border-color: #60a5fa; /* blue-400 */
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5);
            outline: none;
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="w-full max-w-md">
        
        <!-- 
          View 1: Auth Page (Sign Up / Login)
          Initially visible
        -->
        <div id="auth-view" class="auth-card bg-white dark:bg-gray-800 shadow-2xl rounded-xl p-8">
            <h1 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-2">PredictPro</h1>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-6">Sign in or create an account</p>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                    <input type="email" id="email" name="email" required
                           class="form-input w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="password" name="password" required
                           class="form-input w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Min 8 chars, 1 letter, 1 number.</p>
                </div>

                <!-- Error Message Area -->
                <div id="auth-error" class="text-red-500 text-sm font-medium hidden"></div>

                <div class="flex flex-col sm:flex-row gap-3 pt-2">
                    <button type="button" id="login-btn"
                            class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        Login
                    </button>
                    <button type="button" id="signup-btn"
                            class="btn w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        Sign Up
                    </button>
                </div>
            </form>
        </div>

        <!-- 
          View 2: OTP Page
          Initially hidden
        -->
        <div id="otp-view" class="auth-card bg-white dark:bg-gray-800 shadow-2xl rounded-xl p-8 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-3">Enter Verification Code</h2>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-4">An OTP has been sent (check console).</p>

            <!-- STRICT SECURITY WARNING -->
            <div class="bg-red-100 dark:bg-red-900 border-l-4 border-red-500 text-red-700 dark:text-red-200 p-3 rounded-lg mb-4" role="alert">
                <p class="font-bold">Security Warning</p>
                <p class="text-sm">Do not enter an OTP if you did not request it!</p>
            </div>

            <form id="otp-form">
                <div class="flex justify-center gap-2 mb-4" id="otp-inputs">
                    <input type="number" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="number" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="number" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="number" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="number" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="number" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                </div>

                <!-- OTP Error Message Area -->
                <div id="otp-error" class="text-red-500 text-sm font-medium text-center hidden mb-3"></div>

                <div class="text-center text-sm text-gray-600 dark:text-gray-400 mb-4">
                    OTP expires in: <span id="otp-timer" class="font-bold text-gray-900 dark:text-white">60</span>s
                </div>

                <button type="button" id="verify-otp-btn"
                        class="btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    Verify
                </button>
            </form>
            <button id="resend-otp-btn" class="w-full text-center text-sm text-blue-600 hover:underline dark:text-blue-400 mt-4">
                Resend OTP
            </button>
            <button id="back-to-auth-btn" class="w-full text-center text-sm text-gray-600 hover:underline dark:text-gray-400 mt-2">
                Back to Login
            </button>
        </div>

        <!-- 
          View 3: Success Page (APK Download)
          Initially hidden
        -->
        <div id="success-view" class="auth-card bg-white dark:bg-gray-800 shadow-2xl rounded-xl p-8 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-3">Login Successful!</h2>
            <p id="welcome-message" class="text-center text-gray-600 dark:text-gray-400 mb-6"></p>

            <!-- Admin-only section -->
            <div id="admin-panel" class="hidden text-center mb-4">
                <p class="text-yellow-500 font-bold">Super Admin Access Granted.</p>
                <button class="btn w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Access Admin Features
                </button>
            </div>

            <button id="download-apk-btn"
                    class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                Download PredictPro APK
            </button>
            
            <button id="logout-btn" class="w-full text-center text-sm text-red-600 hover:underline dark:text-red-400 mt-6">
                Logout
            </button>
        </div>

    </div>

    <!-- 3. JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE (In-memory, per specification) ---
            let currentUser = null;
            let isSuperAdmin = false;
            let generatedOTP = null;
            let otpTimer = null;
            let otpExpiryTime = null;
            
            // Simulated user database (for production, use a real DB)
            const userDatabase = {
                // Pre-seed the super admin for login testing
                "shadowvybez001@gmail.com": { password: "AdminPassword123" }
            };
            const SUPER_ADMIN_EMAIL = "shadowvybez001@gmail.com";
            const OTP_EXPIRY_SECONDS = 60;

            // --- SELECTORS ---
            const views = {
                auth: document.getElementById('auth-view'),
                otp: document.getElementById('otp-view'),
                success: document.getElementById('success-view')
            };

            // Auth View
            const authForm = document.getElementById('auth-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const signupBtn = document.getElementById('signup-btn');
            const authError = document.getElementById('auth-error');

            // OTP View
            const otpForm = document.getElementById('otp-form');
            const otpInputsContainer = document.getElementById('otp-inputs');
            const otpInputs = otpInputsContainer.querySelectorAll('.otp-input');
            const otpError = document.getElementById('otp-error');
            const otpTimerDisplay = document.getElementById('otp-timer');
            const verifyOtpBtn = document.getElementById('verify-otp-btn');
            const resendOtpBtn = document.getElementById('resend-otp-btn');
            const backToAuthBtn = document.getElementById('back-to-auth-btn');

            // Success View
            const welcomeMessage = document.getElementById('welcome-message');
            const adminPanel = document.getElementById('admin-panel');
            const downloadApkBtn = document.getElementById('download-apk-btn');
            const logoutBtn = document.getElementById('logout-btn');

            // --- HELPER FUNCTIONS ---

            /**
             * Shows a specific view and hides all others
             * @param {string} viewId - 'auth', 'otp', or 'success'
             */
            function showView(viewId) {
                Object.values(views).forEach(view => view.classList.add('hidden'));
                if (views[viewId]) {
                    views[viewId].classList.remove('hidden');
                }
            }

            /**
             * Displays an error message
             * @param {HTMLElement} el - The error display element
             * @param {string} message - The message to show
             */
            function showError(el, message) {
                el.textContent = message;
                el.classList.remove('hidden');
            }

            /**
             * Hides an error message
             * @param {HTMLElement} el - The error display element
             */
            function clearError(el) {
                el.textContent = '';
                el.classList.add('hidden');
            }

            /**
             * Validates email based on strict regex
             * @param {string} email
             * @returns {boolean}
             */
            function validateEmail(email) {
                // Regex from specification
                const re = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;
                return re.test(String(email).toLowerCase());
            }

            /**
             * Validates password based on strict rules
             * @param {string} password
             * @returns {boolean}
             */
            function validatePassword(password) {
                // Min 8 chars, at least 1 letter, 1 number
                const re = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;
                return re.test(password);
            }

            /**
             * Generates and "sends" an OTP
             */
            function sendOTP() {
                // Clear existing timer if any
                if (otpTimer) {
                    clearInterval(otpTimer);
                }

                // 1. Generate 6-digit OTP
                generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
                otpExpiryTime = Date.now() + (OTP_EXPIRY_SECONDS * 1000);

                // 2. Simulate sending OTP (Log to console)
                console.log(`%c[PredictPro Security] OTP for ${currentUser}: ${generatedOTP}`, "color: #007bff; font-weight: bold;");

                // 3. Reset OTP inputs and timer display
                otpInputs.forEach(input => input.value = '');
                clearError(otpError);
                otpTimerDisplay.textContent = OTP_EXPIRY_SECONDS;
                otpInputs[0].focus();

                // 4. Start countdown
                otpTimer = setInterval(() => {
                    const secondsLeft = Math.round((otpExpiryTime - Date.now()) / 1000);
                    if (secondsLeft <= 0) {
                        clearInterval(otpTimer);
                        otpTimerDisplay.textContent = '0';
                        showError(otpError, 'OTP has expired. Please resend.');
                        generatedOTP = null; // Invalidate the OTP
                    } else {
                        otpTimerDisplay.textContent = secondsLeft;
                    }
                }, 1000);
            }
            
            /**
             * Sets up the success page with user-specific info
             */
            function setupSuccessPage() {
                welcomeMessage.textContent = `Welcome, ${currentUser}!`;
                if (isSuperAdmin) {
                    adminPanel.classList.remove('hidden');
                    console.log(`[PredictPro Security] Super Admin login detected: ${currentUser}`);
                } else {
                    adminPanel.classList.add('hidden');
                }
            }

            /**
             * Logs out the user and returns to auth screen
             */
            function logout() {
                currentUser = null;
                isSuperAdmin = false;
                generatedOTP = null;
                if (otpTimer) clearInterval(otpTimer);
                
                // Clear form fields
                emailInput.value = '';
                passwordInput.value = '';
                clearError(authError);
                
                showView('auth');
            }

            // --- EVENT LISTENERS ---

            // 1. Auth View (Login / Sign Up)
            loginBtn.addEventListener('click', () => {
                clearError(authError);
                const email = emailInput.value;
                const password = passwordInput.value;

                // Client-side validation
                if (!validateEmail(email)) {
                    return showError(authError, 'Invalid email format.');
                }
                if (!validatePassword(password)) {
                    return showError(authError, 'Password must be min 8 chars with letters and numbers.');
                }
                
                // Check user in "database"
                if (!userDatabase[email]) {
                    return showError(authError, 'User not found. Please Sign Up.');
                }
                
                if (userDatabase[email].password !== password) {
                    return showError(authError, 'Incorrect password.');
                }

                // --- Login Success ---
                currentUser = email;
                isSuperAdmin = (email === SUPER_ADMIN_EMAIL);
                sendOTP();
                showView('otp');
            });

            signupBtn.addEventListener('click', () => {
                clearError(authError);
                const email = emailInput.value;
                const password = passwordInput.value;

                // Client-side validation
                if (!validateEmail(email)) {
                    return showError(authError, 'Invalid email format.');
                }
                if (!validatePassword(password)) {
                    return showError(authError, 'Password must be min 8 chars with letters and numbers.');
                }
                
                // Check if user already exists
                if (userDatabase[email]) {
                    return showError(authError, 'Email already registered. Please Login.');
                }

                // --- Sign Up Success ---
                // Add to "database" (simulating hashing)
                userDatabase[email] = { password: password };
                console.log("[PredictPro] New user registered:", userDatabase);
                
                currentUser = email;
                isSuperAdmin = (email === SUPER_ADMIN_EMAIL); // Flag if admin signs up
                sendOTP();
                showView('otp');
            });

            // 2. OTP View
            otpInputsContainer.addEventListener('input', (e) => {
                const target = e.target;
                if (target.matches('.otp-input') && target.value.length === target.maxLength) {
                    const next = target.nextElementSibling;
                    if (next && next.matches('.otp-input')) {
                        next.focus();
                    }
                }
            });

            otpInputsContainer.addEventListener('keydown', (e) => {
                const target = e.target;
                if (e.key === 'Backspace' && target.matches('.otp-input') && target.value.length === 0) {
                    const prev = target.previousElementSibling;
                    if (prev && prev.matches('.otp-input')) {
                        prev.focus();
                    }
                }
            });

            // Handle paste event
            otpInputs[0].addEventListener('paste', (e) => {
                e.preventDefault();
                const pasteData = (e.clipboardData || window.clipboardData).getData('text');
                if (pasteData.length === 6 && /^\d+$/.test(pasteData)) {
                    otpInputs.forEach((input, index) => {
                        input.value = pasteData[index];
                    });
                    verifyOtpBtn.focus();
                }
            });

            verifyOtpBtn.addEventListener('click', () => {
                clearError(otpError);
                const enteredOTP = Array.from(otpInputs).map(input => input.value).join('');

                if (enteredOTP.length !== 6) {
                    return showError(otpError, 'Please enter all 6 digits.');
                }

                // Strict Check 1: OTP Expiry
                if (generatedOTP === null) {
                    return showError(otpError, 'OTP has expired. Please resend.');
                }

                // Strict Check 2: OTP Value
                if (enteredOTP !== generatedOTP) {
                    return showError(otpError, 'Invalid OTP. Please try again.');
                }

                // --- OTP Success ---
                clearInterval(otpTimer);
                generatedOTP = null; // Invalidate OTP after use
                setupSuccessPage();
                showView('success');
            });

            resendOtpBtn.addEventListener('click', () => {
                clearError(otpError);
                sendOTP(); // Re-sends and starts new timer
            });
            
            backToAuthBtn.addEventListener('click', () => {
                // Go back without logging out, in case user wants to switch email
                if (otpTimer) clearInterval(otpTimer);
                generatedOTP = null;
                currentUser = null;
                isSuperAdmin = false;
                clearError(authError);
                showView('auth');
            });

            // 3. Success View
            downloadApkBtn.addEventListener('click', () => {
                // In a real app, this would trigger a file download
                console.log(`[PredictPro] User ${currentUser} initiated APK download.`);
                alert('Download started! (Simulation)');
            });

            logoutBtn.addEventListener('click', ()_ => {
                logout();
            });

            // --- INITIALIZATION ---
            showView('auth'); // Start on the auth page
        });
    </script>
</body>
</html>
